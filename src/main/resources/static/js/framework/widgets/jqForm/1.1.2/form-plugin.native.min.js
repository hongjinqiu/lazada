(function(h){h.jForm=h.jForm||{};var g={view:{focusSelectText:true},callback:{beforeSetValue:null,afterSetValue:null,afterGetValue:null,afterDisableElement:null,afterEnableElement:null,afterClick:null,afterFocus:null,afterBlur:null,afterKeyup:null,afterChange:null,afterReset:null},formatter:[],_defaultFormDataStore:{},_defaultFormData:null,_formDataStore:{},_ignoreSetValueFiledNames:[],_isSetValue:false};h.fn.jqForm=function(r){if(typeof r=="string"){var s=h.jForm.getAccessor(h.jForm,r);if(!s){alert("$.jForm - method not found:"+r);return}var q=h.makeArray(arguments).slice(1);return s.apply(this,q)}r=h.extend(true,{},g,r);return this.each(function(){if(this.renderCompleted){return}var t=this;if(h(t).is("form")!==true){alert("Non(form)controls can't initialize!");return}t.p=h.extend(true,{id:t.id},h.jForm,g,r);m.call(t);t.renderCompleted=true})};h.extend(h.jForm,{getAccessor:function(w,v){var r,u,q=[],s;if(typeof v==="function"){return v(w)}r=w[v];if(r===undefined){try{if(typeof v==="string"){q=v.split(".")}s=q.length;if(s){r=w;while(r&&s--){u=q.shift();r=r[u]}}}catch(t){}}return r},setDefaultValue:function(q,r){return this.each(function(){var s=this,u=s.p,t=h(s);if(q==null||!h.isPlainObject(q)){if(console&&console.hasOwnProperty("info")){console.info("Form data is empty or not JSON object！")}return}t.jqForm("reset",true);u._defaultFormDataStore=h.extend(true,{},q);u._formDataStore=h.extend(true,{},q);if(h.isFunction(u.callback.beforeSetValue)){if(u.callback.beforeSetValue.call(s,u._formDataStore)!==true){return}}e.call(s,u._formDataStore);c.call(s,u._formDataStore);if(h.isFunction(u.callback.afterSetValue)){u.callback.afterSetValue.call(s,u._formDataStore)}if(r&&h.isFunction(r)){r.apply(s,[u._formDataStore])}u._defaultFormData=t.jqForm("getValue")})},setValue:function(q,r){return this.each(function(){var s=this,t=h(s),v=s.p,u;if(q==null||!h.isPlainObject(q)){if(console&&console.hasOwnProperty("info")){console.info("Form data is empty or not JSON object!")}return}u=t.jqForm("getValue");v._formDataStore=h.extend(true,{},u,q);if(h.isFunction(v.callback.beforeSetValue)){if(v.callback.beforeSetValue.call(s,v._formDataStore)!==true){return}}e.call(s,v._formDataStore);c.call(s,v._formDataStore);if(h.isFunction(v.callback.afterSetValue)){v.callback.afterSetValue.call(s,v._formDataStore)}if(r&&h.isFunction(r)){r.apply(s,[v._formDataStore])}})},getValue:function(q,s){var r={};this.each(function(){var t=this,y=t.p,x=null,v=null,u=null,w=null;h("[name]",t).each(function(){u=h(this);v=u.attr("name");w=h("[name='"+u.attr("name")+"']",t);if(u.is("input[type='radio']")){x=h("input[name='"+v+"']:checked",t).val();x=x==undefined?null:x}else{if(u.is("input[type='checkbox']")&&w.length==1){x=h("input[name='"+v+"']:checked",t).val();x=x==undefined?null:x}else{if(w.length>1){x=[];w.each(function(){var z=h(this);if(z.is("input[type='checkbox']")){if(z.prop("checked")){x.push(h.trim(z.val())===""?null:z.val())}}})}else{if(u.is("input")||u.is("textarea")||u.is("select")){x=u.val()}else{x=u.text()}}}}d(r,v,x);w=null});if(q===false){}else{n.call(t,r)}r=h.extend({},y._formDataStore,r);if(h.isFunction(y.callback.afterGetValue)){y.callback.afterGetValue.call(t,r)}if(s&&h.isFunction(s)){s.apply(t,[r])}});return r},isDirty:function(w){if(this.length==0){return void (0)}var r=this[0],v=r.p,s=0,t,q,u={};if(v._defaultFormData){u=h(r).jqForm("getValue");if(!!w===false){t=Object.keys(u).sort();q=Object.keys(v._defaultFormData).sort();if(q.join(",")!==t.join(",")){return true}for(s=0;s<t.length;s++){if(u[t[s]]!=v._defaultFormData[t[s]]){return true}}return false}return u&&(JSON.stringify(u)!=JSON.stringify(v._defaultFormData))}return !!v._isSetValue},reset:function(r){var q,s=function(t){t.reset();h("[name]",t).each(function(u,v){q=h(v);if(q.is("input")||q.is("textarea")||q.is("select")){if(q.is("input[type='hidden']")==true){q.val("")}}else{q.text("")}})};return this.each(function(){var t=this,u=t.p;if(r===true){u._defaultFormDataStore={};u._defaultFormData=null;u._formDataStore={};u._isSetValue=false;s(t)}else{if(u._defaultFormDataStore&&!h.isEmptyObject(u._defaultFormDataStore)){h(t).jqForm("setDefaultValue",u._defaultFormDataStore)}else{u._defaultFormDataStore={};u._defaultFormData=null;u._formDataStore={};u._isSetValue=false;s(t)}}if(h.isFunction(u.callback.afterReset)){u.callback.afterReset.call(t)}})},disableElement:function(q,r){if(!h.isArray(q)){if(console&&console.hasOwnProperty("info")){console.info(q+"，Must be an array！")}return}return this.each(function(){var t=this,x=t.p,u=h(t),w,v={},s;for(w=0;w<q.length;w++){v=q[w];if(!v.fieldName){continue}if(v.fieldName==="*"){u.find("[name]").each(function(z,y){s=h(y);if(!s.is("[type='hidden']")){s.attr({disabled:"disabled"})}})}else{u.find("[name='"+v.fieldName+"']").each(function(z,y){s=h(y);if(!s.is("[type='hidden']")){s.attr({disabled:"disabled"})}})}}if(h.isFunction(x.callback.afterDisableElement)){x.callback.afterDisableElement.call(t,q)}if(r&&h.isFunction(r)){r.apply(t,[q])}})},enableElement:function(q,r){if(!h.isArray(q)){if(console&&console.hasOwnProperty("info")){console.info(q+"，Must be an array！")}return}return this.each(function(){var s=this,w=s.p,t=h(s),v,u={};for(v=0;v<q.length;v++){u=q[v];if(!u.fieldName){continue}if(u.fieldName==="*"){t.find("[name]").removeAttr("disabled")}else{t.find("[name="+u.fieldName+"]").removeAttr("disabled")}}if(h.isFunction(w.callback.afterEnableElement)){w.callback.afterEnableElement.call(s,q)}if(r&&h.isFunction(r)){r.apply(s,[q])}})},focusToElement:function(q){return this.each(function(){var r=this;h("[name='"+q+"']",r).focus()})},allowFocusElement:function(){var q=[];this.each(function(){var r=this;h('input:enabled:not(:checkbox):not(:radio):not(:button):not([readonly="readonly"]):not(:hidden)',r).each(function(){q.push(this)});q=q.concat();h('select:enabled:not([readonly="readonly"]):not(:hidden)',r).each(function(){q.push(this)});h('textarea:enabled:not([readonly="readonly"]):not(:hidden)',r).each(function(){q.push(this)})});return q}});var m=function(){h(this).each(function(){var q=this,r=h(q),t=q.p,s;r.find("[name]").off("click.jqForm");r.find("[name]").on("click.jqForm",function(u){if(h.isFunction(t.callback.afterClick)){s=r.jqForm("getValue");t.callback.afterClick.call(q,u,h(this).attr("name"),s)}});r.find("[name]").off("focus.jqForm");r.find("[name]").on("focus.jqForm",function(v){var u=h(this);if(t.view.focusSelectText&&u.is("input:text")&&!u.prop("disabled")&&!u.prop("readonly")){var w=window.setTimeout(function(){if(u.is(":focus")){u.select()}window.clearTimeout(w)},1)}if(h.isFunction(t.callback.afterFocus)){s=r.jqForm("getValue");t.callback.afterFocus.call(q,v,u.attr("name"),s)}});r.find("[name]").off("blur.jqForm");r.find("[name]").on("blur.jqForm",function(u){if(h.isFunction(t.callback.afterBlur)){s=r.jqForm("getValue");t.callback.afterBlur.call(q,u,h(this).attr("name"),s)}});r.find("[name]").off("keyup.jqForm");r.find("[name]").on("keyup.jqForm",function(u){if(h.isFunction(t.callback.afterKeyup)){s=r.jqForm("getValue");t.callback.afterKeyup.call(q,u,h(this).attr("name"),s)}});r.find("select[name]").off("change.jqForm");r.find("select[name]").on("change.jqForm",function(u){if(h.isFunction(t.callback.afterChange)){s=r.jqForm("getValue");t.callback.afterChange.call(q,u,h(this).attr("name"),s)}})})},i=function(q,s){var t;if(s.indexOf(".")>-1){var r=s.substring(0,s.indexOf("."));s=s.substring(s.indexOf(".")+1,s.length);if(q.hasOwnProperty(r)){t=i(q[r],s)}else{t=undefined}}else{t=q[s]}return t},d=function(q,s,t){if(s.indexOf(".")>-1){var r=s.substring(0,s.indexOf("."));s=s.substring(s.indexOf(".")+1,s.length);q[r]=q[r]||{};d(q[r],s,t)}else{q[s]=t}},c=function(q){return h(this).each(function(){var z=this,s=z.p,t,v,r,A,w,y,x=0,u=false;s._isSetValue=true;t=h("[name]",z);for(y=0;y<t.length;y++){v=h(t[y]);r=v.attr("name");u=false;if(r&&r.length>0){for(x=0;x<s._ignoreSetValueFiledNames.length;x++){if(r==s._ignoreSetValueFiledNames[x]){u=true;break}}}if(u){continue}w=i(q,r);if(v.is("input[type='radio']")){h("input[name='"+r+"'][value='"+w+"']",z).prop("checked",true)}else{if(v.is("input[type='checkbox']")){A=h.isArray(w)?w:[w];h("input[name='"+r+"']",z).val(A)}else{if(v.is("input")||v.is("textarea")||v.is("select")){if(w!==null){v.val(w)}}else{if(w!==null){v.text(w)}}}}}})},p=function(q){return h(this).each(function(){var r=this,u=r.p,t,s=false;for(t=0;t<u._ignoreSetValueFiledNames.length;t++){if(q==u._ignoreSetValueFiledNames[t]){s=true;break}}if(s===false){u._ignoreSetValueFiledNames.push(q)}})},e=function(q){return h(this).each(function(){var s=this,v=s.p,u=0,r={},t="";if(v.formatter&&v.formatter.length>0){for(;u<v.formatter.length;u++){r=v.formatter[u];if(r){if(r.format==="date"){t=o.call(s,r.fieldName,r,i(q,r.fieldName));d(q,r.fieldName,t)}if(r.format==="textValue"){t=l.call(s,r.fieldName,r,i(q,r.fieldName));d(q,r.fieldName,t)}if(r.format==="singleCheckbox"){t=a.call(s,r.fieldName,r,i(q,r.fieldName));d(q,r.fieldName,t)}}}}})},n=function(q){return h(this).each(function(){var s=this,v=s.p,t=0,r={},u="";if(v.formatter&&v.formatter.length>0){for(;t<v.formatter.length;t++){r=v.formatter[t];if(r){if(r.format==="date"){u=k.call(s,r.fieldName,r,i(q,r.fieldName));d(q,r.fieldName,u)}if(r.format==="textValue"){u=j.call(s,r.fieldName,r,i(q,r.fieldName));d(q,r.fieldName,u)}if(r.format==="singleCheckbox"){u=f.call(s,r.fieldName,r,i(q,r.fieldName));d(q,r.fieldName,u)}}}}})},o=function(u,q,t){var r=q.dateFormat||"yyyy-MM-dd",s=function(v,y){var x=new Date(y),z={"M+":x.getMonth()+1,"d+":x.getDate(),"h+":x.getHours(),"m+":x.getMinutes(),"s+":x.getSeconds(),"q+":Math.floor((x.getMonth()+3)/3),S:x.getMilliseconds()};if(/(y+)/.test(v)){v=v.replace(RegExp.$1,(x.getFullYear()+"").substr(4-RegExp.$1.length))}for(var w in z){if(new RegExp("("+w+")").test(v)){v=v.replace(RegExp.$1,(RegExp.$1.length==1)?(z[w]):(("00"+z[w]).substr((""+z[w]).length)))}}return v};if(t){return s(r,Number(t))}else{return t}},k=function(u,r,t){var q=this,s=r.dateFormat||"yyyy-MM-dd";if(t){return Date.parse(b.call(q,t,s))}else{return t}},b=function(y,x){if(!y){return y}if(y instanceof Date){return y}var u,t,r,z,w={yyyy:0,M:0,d:0,h:0,m:0,s:0};x=q(x);u=y&&y.toString().match(/[^ -\/:-@\[-`{-~\t\n\rTZ]+/g)||[];z={h:function(A){w.h=A},M:function(A){A-=1;w.M=A},m:function(A){w.m=A},s:function(A){w.s=A},yyyy:function(A){w.yyyy=A},yy:function(A){w.yyyy=A},d:function(A){w.d=A}};z.dd=z.d;z.ss=z.s;z.mm=z.m;z.MM=z.M;z.HH=z.H=z.hh=z.h;if(u.length==x.parts.length){for(var v=0,s=x.parts.length;v<s;v++){t=parseInt(u[v],10);r=x.parts[v];z[x.parts[v]](t)}}function q(D){var B=/hh?|HH?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g,A=D.replace(B,"\0").split("\0"),C=D.match(B);if(!A||!A.length||!C||C.length==0){throw new Error("Invalid date format.")}return{separators:A,parts:C}}return new Date(w.yyyy,w.M,w.d,w.h,w.m,w.s)},l=function(t,q,s){var r=q.dataMap;if(r){return r[s]}else{throw new Error("dataMap no configuration!")}},j=function(v,q,s){var r=q.dataMap,t,u=null;for(t in r){if(r[t]==s){u=t;break}}return u},a=function(s,q,r){h(this).each(function(){var t=this,v=h('input[name="'+s+'"]',t),u=q.dataMap;if(v.length==0){return}if(!v.is("input:checkbox")){throw new Error(s+" non checkbox control!")}if(u){if(u.checked===r){v.prop("checked",true)}else{v.prop("checked",false)}p.call(t,s)}else{throw new Error("dataMap no configuration!")}});return r},f=function(t,q,s){var r;h(this).each(function(){var u=this,w=h('input[name="'+t+'"]',u),v=q.dataMap,x=false;if(w.length>0){x=w.prop("checked");r=x===true?v.checked:v.unchecked}});return r}})(jQuery);